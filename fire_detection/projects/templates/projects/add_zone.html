{% extends 'base.html' %}
{% load role_colors %}

{% block title %}Add Zone - Fire Detection{% endblock %}

{% block navbar_brand_url %}{% url 'supervisor_dashboard' %}{% endblock %}

{% block navbar_content %}
<ul class="navbar-nav me-auto">
    <li class="nav-item">
        <a class="nav-link" href="{% url 'supervisor_dashboard' %}">
            <i class="bi bi-speedometer2"></i> Dashboard
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'projects:project_list' %}">
            <i class="bi bi-folder"></i> Projects
        </a>
    </li>
</ul>
{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css">
<style>
    #map {
        height: 500px;
        border-radius: 12px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="card border-0 {% get_role_bg user %} text-white mb-4 shadow-lg">
        <div class="card-body py-4">
            <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-4">
                <div>
                    <h1 class="h2 mb-2">Define Surveillance Zones</h1>
                    <p class="mb-0 lead">Draw the zones to be covered for your project with precision.</p>
                </div>
                <div class="d-flex gap-3">
                    <div class="badge bg-white text-dark rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">1</div>
                    <div class="badge bg-white {% get_role_text user %} rounded-circle d-flex align-items-center justify-content-center fw-bold" style="width: 50px; height: 50px;">2</div>
                    <div class="badge bg-white text-dark rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">3</div>
                </div>
            </div>
        </div>
    </div>

    {% if messages %}
        <div class="col-lg-6 mx-auto mb-4">
            {% for message in messages %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="row g-4">
            <div class="col-lg-5">
                <div class="card shadow-lg border-0 h-100">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center gap-3 mb-4">
                            <span class="badge {% get_role_badge user %} rounded-pill px-3 py-2 fs-6">
                                <i class="bi bi-diagram-3 me-2"></i>
                                Project: <span class="fw-semibold">{{ votre_projet }}</span>
                            </span>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-semibold text-uppercase small text-muted mb-2" for="name_zone">Zone Name</label>
                            <input type="text" id="name_zone" class="form-control form-control-lg"
                                   placeholder="e.g. East Zone" name="name_zone" autocomplete="off">
                        </div>

                        <input type="text" id="coords_polys" class="form-control" name="coords_polys" hidden>

                        <div class="mb-4">
                            <label class="form-label fw-semibold text-uppercase small text-muted mb-2" for="description">Description</label>
                            <textarea class="form-control" placeholder="Detail the characteristics of the zone"
                                      id="description" name="description" rows="5"></textarea>
                        </div>

                        <div class="d-flex flex-column flex-md-row gap-3">
                            <button class="btn btn-outline-secondary rounded-pill px-4 py-3 fw-semibold" type="submit" value="false" name="ajoutez_un_polygone">
                                <i class="bi bi-plus-circle me-2"></i> Add Another Zone
                            </button>
                            <button class="btn {% get_role_btn user %} rounded-pill px-4 py-3 fw-semibold text-uppercase" type="submit">
                                Next Step
                                <i class="bi bi-arrow-right-circle ms-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-7">
                <div class="card shadow-lg border-0 h-100">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h2 class="h5 fw-semibold mb-0">
                                <i class="bi bi-map me-2"></i>Draw on Map
                            </h2>
                            <span class="badge {% get_role_badge user %} rounded-pill">
                                <i class="bi bi-geo-alt-fill me-1"></i>
                                Leaflet Draw
                            </span>
                        </div>
                        <div class="alert alert-info mb-3" role="alert">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Instructions:</strong> Use the polygon tool (<i class="bi bi-pentagon"></i>) to draw a zone. You can modify or delete the polygon.
                        </div>
                        <div id="map" class="w-100"></div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
    const map = L.map("map").setView([36.89186227222111, 10.187473488849253], 13);

    L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
        attribution: "Leaflet Map ©",
    }).addTo(map);

    var geocoder = L.Control.geocoder({
        defaultMarkGeocode: false,
        placeholder: "Rechercher des localisations",
        errorMessage: "Non Trouvé"
    }).on('markgeocode', function (e) {
        var bbox = e.geocode.bbox;
        var poly = L.polygon([
            bbox.getSouthEast(),
            bbox.getNorthEast(),
            bbox.getNorthWest(),
            bbox.getSouthWest()
        ]);
        map.fitBounds(poly.getBounds(), {
            maxZoom: 16
        });
    }).addTo(map);

    var drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    var drawControl = new L.Control.Draw({
        draw: {
            polygon: {
                shapeOptions: {
                    color: "#198754",
                },
            },
            polyline: false,
            rectangle: false,
            circle: false,
            marker: false,
            circlemarker: false,
        },
        edit: {
            featureGroup: drawnItems,
            remove: true,
        },
    });

    map.addControl(drawControl);

    function updatePolygonCoordinates(layer) {
        var myjson = layer.toGeoJSON();
        let coords = myjson.features[0].geometry.coordinates;
        const multiPolygon = {
            type: "MultiPolygon",
            coordinates: [coords],
        };
        document.getElementById("coords_polys").value = JSON.stringify(multiPolygon);
    }

    map.on("draw:created", function (e) {
        var type = e.layerType, layer = e.layer;
        if (type === "polygon") {
            if(drawnItems.getLayers().length === 0) {
                drawnItems.addLayer(layer);
                updatePolygonCoordinates(drawnItems);
            } else {
                alert("Seul un polygone à la fois peut être dessiné !");
            }
        }
    });

    map.on("draw:edited", function (e) {
        var layers = e.layers;
        layers.eachLayer(function (layer) {
            if (layer instanceof L.Polygon) {
                updatePolygonCoordinates(drawnItems);
            }
        });
    });

    map.on("draw:deleted", function(e) {
        var layers = e.layers;
        layers.eachLayer(function(layer) {
            if (layer instanceof L.Polygon) {
                document.getElementById("coords_polys").value = "";
                document.getElementById("name_zone").value = "";
                document.getElementById("description").value = "";
            }
        });
    });

    // Add existing zones on the map
    {% for zone_data in zones_data %}
        {% if zone_data.coords_json != 'null' %}
        (function() {
            try {
                const geojson = {{ zone_data.coords_json|safe }};
                const polygonLayer = L.geoJSON(geojson).addTo(map);
                const tooltipContent = "<b>{{ zone_data.zone.name_zone|escapejs }}</b><br>{{ zone_data.zone.description_zone|default:""|escapejs }}";
                polygonLayer.bindTooltip(tooltipContent, { permanent: true, direction: 'center' }).openTooltip();
            } catch(e) {
                console.error('Error loading zone:', e);
            }
        })();
        {% endif %}
    {% endfor %}
</script>
{% endblock %}
